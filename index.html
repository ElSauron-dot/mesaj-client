<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mesaj & Sesli Sohbet</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="app">
    <header>
        <h1>Mesajlar</h1>
        <nav>
            <button id="tabMessages">Mesajlar</button>
            <button id="tabCalls">Aramalar</button>
        </nav>
        <button id="clearBtn">ðŸ—‘ Temizle</button>
    </header>

    <main id="messagesView">
        <div id="messages" class="messages"></div>
        <div class="input-area">
            <input type="text" id="nameInput" placeholder="AdÄ±nÄ±z">
            <input type="text" id="messageInput" placeholder="Mesaj yaz...">
            <button id="sendBtn">GÃ¶nder</button>
        </div>
    </main>

    <main id="callsView" style="display:none;">
        <h2>Sesli Kanallar</h2>
        <ul id="voiceChannelList"></ul>
        <input type="text" id="newChannelName" placeholder="Yeni kanal adÄ±">
        <button id="addChannelBtn">Ekle</button>
    </main>
</div>

<script>
const serverUrl = "wss://mesaj-server.onrender.com"; // Render URL
const ws = new WebSocket(serverUrl);

// WebRTC deÄŸiÅŸkenleri
let localStream;
let peers = {};
let username = "";

document.getElementById("tabMessages").onclick = () => {
    document.getElementById("messagesView").style.display = "block";
    document.getElementById("callsView").style.display = "none";
};
document.getElementById("tabCalls").onclick = () => {
    document.getElementById("messagesView").style.display = "none";
    document.getElementById("callsView").style.display = "block";
};

document.getElementById("sendBtn").onclick = () => {
    username = document.getElementById("nameInput").value.trim();
    const text = document.getElementById("messageInput").value.trim();
    if (!username || !text) return;
    ws.send(JSON.stringify({ type: 'message', name: username, text }));
    document.getElementById("messageInput").value = "";
};

document.getElementById("clearBtn").onclick = () => {
    document.getElementById("messages").innerHTML = "";
};

document.getElementById("addChannelBtn").onclick = () => {
    const channel = document.getElementById("newChannelName").value.trim();
    if (!channel) return;
    ws.send(JSON.stringify({ type: 'addVoiceChannel', channel }));
    document.getElementById("newChannelName").value = "";
};

// Ses kanalÄ±na baÄŸlanma
function joinVoiceChannel(channelName) {
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        localStream = stream;
        ws.send(JSON.stringify({ type: "joinVoice", channel: channelName, name: username }));

        // Yeni kullanÄ±cÄ±ya offer gÃ¶nder
        ws.onmessage = async (event) => {
            const data = JSON.parse(event.data);

            if (data.type === 'voiceChannels') {
                updateChannelList(data.channels);
            }

            if (data.type === 'message') {
                addMessage(data.name, data.text);
            }

            if (data.type === 'history') {
                document.getElementById("messages").innerHTML = "";
                data.messages.forEach(m => addMessage(m.name, m.text));
            }

            if (data.type === "offer") {
                const pc = createPeer(data.from);
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                ws.send(JSON.stringify({ type: "answer", answer, to: data.from }));
            }

            if (data.type === "answer" && peers[data.from]) {
                await peers[data.from].setRemoteDescription(new RTCSessionDescription(data.answer));
            }

            if (data.type === "candidate" && peers[data.from]) {
                await peers[data.from].addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        };
    });
}

function createPeer(id) {
    const pc = new RTCPeerConnection();
    peers[id] = pc;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    pc.ontrack = event => {
        const audio = document.createElement("audio");
        audio.srcObject = event.streams[0];
        audio.autoplay = true;
        document.body.appendChild(audio);
    };
    pc.onicecandidate = event => {
        if (event.candidate) {
            ws.send(JSON.stringify({ type: "candidate", candidate: event.candidate, to: id }));
        }
    };
    return pc;
}

function addMessage(name, text) {
    const div = document.createElement("div");
    div.className = "message";
    div.innerHTML = `<strong>${name}:</strong> ${text}`;
    document.getElementById("messages").appendChild(div);
    div.scrollIntoView();
}

function updateChannelList(channels) {
    const list = document.getElementById("voiceChannelList");
    list.innerHTML = "";
    channels.forEach(c => {
        const li = document.createElement("li");
        li.textContent = c;
        li.onclick = () => joinVoiceChannel(c);
        list.appendChild(li);
    });
}

ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'history') {
        document.getElementById("messages").innerHTML = "";
        data.messages.forEach(m => addMessage(m.name, m.text));
    }
    if (data.type === 'message') {
        addMessage(data.name, data.text);
    }
    if (data.type === 'voiceChannels') {
        updateChannelList(data.channels);
    }
};
</script>
</body>
</html>

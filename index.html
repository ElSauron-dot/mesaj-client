<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Meet</title>
<style>
  body { font-family: Arial; display: flex; flex-direction: column; align-items: center; background: #f2f2f2; }
  video { width: 300px; margin: 5px; border-radius: 5px; background: black; }
  #videos { display: flex; flex-wrap: wrap; justify-content: center; }
</style>
</head>
<body>

<h2>Mini Meet - Sesli & Görüntülü Arama</h2>
<input type="text" id="roomInput" placeholder="Oda ID'si girin" />
<button id="joinBtn">Odaya Katıl</button>

<div id="videos"></div>

<script src="https://cdn.jsdelivr.net/npm/socket.io@4.7.2/dist/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
<script>
const socket = io();
const videos = document.getElementById('videos');
let localStream;
let peers = {};

const joinBtn = document.getElementById('joinBtn');
joinBtn.onclick = async () => {
    const roomID = document.getElementById('roomInput').value;
    if (!roomID) return alert("Oda ID'si girin!");

    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

    const localVideo = document.createElement('video');
    localVideo.srcObject = localStream;
    localVideo.muted = true;
    localVideo.autoplay = true;
    videos.appendChild(localVideo);

    socket.emit('join-room', roomID);

    socket.on('user-connected', userID => {
        const peer = new SimplePeer({ initiator: true, trickle: false, stream: localStream });
        peer.on('signal', signal => {
            socket.emit('signal', { to: userID, signal });
        });
        peer.on('stream', stream => addVideoStream(stream));
        peers[userID] = peer;
    });

    socket.on('signal', async data => {
        if (!peers[data.from]) {
            const peer = new SimplePeer({ initiator: false, trickle: false, stream: localStream });
            peer.on('signal', signal => socket.emit('signal', { to: data.from, signal }));
            peer.on('stream', stream => addVideoStream(stream));
            peers[data.from] = peer;
            peer.signal(data.signal);
        } else {
            peers[data.from].signal(data.signal);
        }
    });

    socket.on('user-disconnected', id => {
        if (peers[id]) {
            peers[id].destroy();
            delete peers[id];
        }
    });
};

function addVideoStream(stream) {
    const video = document.createElement('video');
    video.srcObject = stream;
    video.autoplay = true;
    videos.appendChild(video);
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Mesajlaşma ve Sesli Sohbet</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div id="app">
    <header>
        <h1>Mesajlaşma Uygulaması</h1>
        <button id="clearBtn">Tüm Mesajları Temizle</button>
    </header>
    <main>
        <aside>
            <button class="tab-btn active" data-tab="messages">Mesajlar</button>
            <button class="tab-btn" data-tab="calls">Aramalar</button>
        </aside>
        <section id="messagesTab" class="tab active">
            <div id="messages"></div>
            <div id="inputArea">
                <input type="text" id="messageInput" placeholder="Mesaj yaz..." autocomplete="off">
                <button id="sendBtn">Gönder</button>
            </div>
        </section>
        <section id="callsTab" class="tab">
            <h2>Sesli Kanallar</h2>
            <div id="voiceChannels"></div>
            <div id="currentChannel"></div>
        </section>
    </main>
</div>

<script>
const ws = new WebSocket("https://mesaj-server.onrender.com");
let userName = prompt("Kullanıcı adın:");
ws.addEventListener("open", () => {
    ws.send(JSON.stringify({ type: "join", name: userName }));
});

const messagesDiv = document.getElementById("messages");
const input = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");
const voiceChannelsDiv = document.getElementById("voiceChannels");

function addMessage(name, text, time) {
    const div = document.createElement("div");
    div.classList.add("message");
    div.innerHTML = `<strong>${name}</strong>: ${text}`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

sendBtn.addEventListener("click", () => {
    const text = input.value.trim();
    if (text) {
        ws.send(JSON.stringify({ type: "message", name: userName, text }));
        input.value = "";
    }
});

input.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
        sendBtn.click();
    }
});

clearBtn.addEventListener("click", () => {
    messagesDiv.innerHTML = "";
});

ws.addEventListener("message", (event) => {
    const data = JSON.parse(event.data);

    if (data.type === "history") {
        data.messages.forEach(m => addMessage(m.name, m.text, m.time));
    }
    if (data.type === "message") {
        addMessage(data.name, data.text, data.time);
    }
    if (data.type === "voiceChannels") {
        voiceChannelsDiv.innerHTML = "";
        for (let channel in data.channels) {
            const btn = document.createElement("button");
            btn.textContent = `${channel} (${data.channels[channel].length})`;
            btn.onclick = () => joinVoice(channel);
            voiceChannelsDiv.appendChild(btn);

            // Kanaldaki kullanıcıları listele
            const ul = document.createElement("ul");
            data.channels[channel].forEach(u => {
                const li = document.createElement("li");
                li.textContent = u;
                ul.appendChild(li);
            });
            voiceChannelsDiv.appendChild(ul);
        }
    }
});

// Sesli arama WebRTC
let localStream;
let pc;
async function joinVoice(channel) {
    ws.send(JSON.stringify({ type: "joinVoice", channel }));

    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    pc = new RTCPeerConnection();
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.ontrack = (event) => {
        const audio = document.createElement("audio");
        audio.srcObject = event.streams[0];
        audio.autoplay = true;
        document.body.appendChild(audio);
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    ws.send(JSON.stringify({ type: "offer", sdp: offer, target: null }));
}
</script>
</body>
</html>
